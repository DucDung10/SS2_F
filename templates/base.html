<!DOCTYPE html>
<html lang="vie">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.8/dist/trix.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-fileinput@5.5.2/css/fileinput.min.css">


    <title>{% block title %}FIT Research Connect{% endblock %}</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body class="d-flex flex-column min-vh-100">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('home') }}">FIT Research Connect</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            {% if current_user.is_authenticated %}
                {# --- Navbar KHI ĐÃ ĐĂNG NHẬP --- #}
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{{ url_for('dashboard') }}">Trang chủ</a>
                    </li>
                    {% if current_user.role == 'lecturer' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('create_post') }}">Đăng bài</a>
                        </li>
                        <li class="nav-item"> {# Sửa lỗi thiếu thẻ li ở đây #}
                            <a class="nav-link" href="{{ url_for('view_pending_ideas') }}">Ý tưởng Sinh viên</a>
                        </li>
                    {% endif %}
                    {% if current_user.role == 'student' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('my_interests') }}">Đề tài quan tâm</a>
                        </li>


                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('my_ideas') }}">Ý tưởng của tôi</a>
                        </li>
                    {% endif %}
                </ul>
                {# --- SỬA LẠI DIV BAO QUANH FORM TÌM KIẾM --- #}
                {# Thêm flex-grow-1 để nó chiếm không gian thừa, dùng mx-lg-2 để có chút margin ngang trên màn lớn #}
                <div class="flex-grow-1 mx-lg-2 position-relative">
                    <form class="d-flex" role="search" method="GET" action="{{ url_for('search_results') }}">
                        <input class="form-control me-2" type="search" placeholder="Tìm kiếm..."
                               aria-label="Search" name="q" id="navbarSearchInput" autocomplete="off"
                               value="{{ request.args.get('q', '') }}">
                        <button class="btn btn-outline-light" type="submit">Tìm</button>
                    </form>
                    {# Div hiển thị gợi ý (giữ nguyên) #}
                    <div class="dropdown-menu" id="searchResultsDropdown"
                         style="width: 100%; display: none; position: absolute; top: 100%; z-index: 1050;">
                    </div>
                </div>


                {# Cụm icon/user bên phải, thêm ms-lg-auto để đẩy sang phải trên màn lớn #}
                <ul class="navbar-nav ms-lg-auto">
                    <li class="nav-item position-relative"> {# <<< Thêm position-relative vào li #}
                        {# Link đến trang thông báo (sẽ tạo sau) #}
                        {# TODO: Tạo route 'notifications' #}
                        <a class="nav-link" href="{{ url_for('notifications') }}" title="Thông báo">
                            <i class="bi bi-bell-fill"></i>
                            {# <<< THÊM KHỐI IF HIỂN THỊ CHẤM ĐỎ >>> #}
                            {% if current_user.is_authenticated and unread_count > 0 %}
                                <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
                                    <span class="visually-hidden">Thông báo mới</span> {# Cho accessibility #}
                                </span>
                            {% endif %}
                            {# <<< KẾT THÚC KHỐI IF >>> #}
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#"
                           id="navbarDropdownUserLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">

                            {# --- Logic xác định URL ảnh đại diện (ĐÚNG) --- #}
                            {# 1. Lấy tên file từ DB, nếu không có thì dùng default.jpg #}
                            {% set image_filename = current_user.image_file if current_user.image_file else 'default.jpg' %}
                            {# 2. Mặc định thư mục là user_pics #}
                            {% set image_folder = 'user_pics' %}

                            {# 3. KIỂM TRA: Nếu tên file LÀ default -> Đổi sang thư mục profile_pics #}
                            {% if image_filename.startswith('default') %}
                                {% set image_folder = 'profile_pics' %} {# Đổi thư mục #}
                                {# Chọn ảnh default cụ thể theo giới tính #}
                                {% if current_user.gender == 'female' %}
                                    {% set image_filename = 'default_female.jpg' %}
                                {% elif current_user.gender == 'male' %}
                                    {% set image_filename = 'default_male.jpg' %}
                                {% else %}
                                    {% set image_filename = 'default.jpg' %} {# Fallback #}
                                {% endif %}
                            {% endif %} {# Kết thúc kiểm tra default #}

                            {# 4. Tạo URL cuối cùng #}
                            {% set avatar_url = url_for('static', filename=image_folder + '/' + image_filename) %}
                            {# --- Kết thúc Logic --- #}

                            {# 5. Hiển thị ảnh - dùng cho Navbar #}
                            <img src="{{ avatar_url }}" alt="Avatar" class="rounded-circle me-2" width="32" height="32"
                                 style="object-fit: cover;">

                            {# Hiển thị tên #}
                            {{ current_user.full_name }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownUserLink">
                            <li><a class="dropdown-item" href="{{ url_for('account') }}">Hồ sơ</a></li>
                            <li><a class="dropdown-item" href="#">Cài đặt</a></li>
                            {# Khối chỉ hiển thị cho Admin #}
                            {% if current_user.is_authenticated and current_user.role == 'admin' %}
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                {# Link đến trang Admin Dashboard #}
                                <li><a class="dropdown-item" href="{{ url_for('admin.index') }}">Trang Admin</a></li>

                            {% endif %}
                            {% if current_user.is_authenticated and current_user.role == 'lecturer' %}
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                {# <<< THÊM DÒNG NÀY >>> #}
                                <li><a class="dropdown-item" href="{{ url_for('my_posts') }}">Bài đã đăng</a></li>
                            {% endif %}


                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            {% else %}
                {# --- Navbar KHI CHƯA ĐĂNG NHẬP --- #}
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0"> {# ms-auto đẩy sang phải #}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">Đăng nhập</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-outline-light btn-sm" href="{{ url_for('register') }}">Đăng ký</a>
                    </li>
                </ul>
            {% endif %}
        </div>
    </div>
</nav>

<main class="container mt-4">

    {# Content Block giữ nguyên #}
    {% block content %}{% endblock %}
</main>

{# Scripts giữ nguyên #}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-fileinput@5.5.2/js/plugins/piexif.min.js"
        type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-fileinput@5.5.2/js/plugins/sortable.min.js"
        type="text/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-fileinput@5.5.2/js/fileinput.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap-fileinput@5.5.2/js/locales/vi.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script type="text/javascript" src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js"></script>


{% block scripts %}{% endblock %}
 {# === THÊM ĐOẠN CODE HIỂN THỊ FLASH MESSAGES === #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <script>
                // Đợi DOM load xong mới chạy script
                document.addEventListener('DOMContentLoaded', function() {
                    const toastContainer = document.querySelector('.toast-container');
                    if (toastContainer) {
                        {% for category, message in messages %}
                            const toastId = 'flash-toast-{{ loop.index }}';
                            // Xác định class màu nền dựa trên category (success, danger, warning, info)
                            const bgClass = 'text-bg-' + ('{{ category }}' || 'secondary'); // Mặc định là secondary nếu không có category

                            const toastHTML = `
                            <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                              <div class="d-flex">
                                <div class="toast-body">
                                  {{ message | safe }} {# Dùng safe nếu message có thể chứa HTML #}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                              </div>
                            </div>`;

                            // Thêm toast vào container
                            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                            const toastElement = document.getElementById(toastId);

                            // Khởi tạo và hiển thị toast
                            if (toastElement) {
                                const toast = new bootstrap.Toast(toastElement, {
                                    delay: 5000 // Tự động ẩn sau 5 giây (tùy chỉnh)
                                });
                                toast.show();
                                // Optional: Xóa toast khỏi DOM sau khi nó đã ẩn hoàn toàn
                                toastElement.addEventListener('hidden.bs.toast', function () {
                                    toastElement.remove();
                                });
                            }
                        {% endfor %}
                    } else {
                        console.warn('Toast container not found for flash messages.');
                    }
                });
            </script>
        {% endif %}
    {% endwith %}
    {# === KẾT THÚC CODE HIỂN THỊ FLASH MESSAGES === #}


<footer class="bg-dark text-light text-center py-3 mt-auto">
    {# mt-auto giúp đẩy footer xuống dưới cùng nếu trang ngắn #}
    <div class="container">
        {# Thay 2025 bằng năm hiện tại nếu muốn hoặc giữ nguyên #}
        <p class="mb-0 small">&copy; 2025 Khoa Công nghệ Thông tin - Đại học Hà Nội</p>
        {# Thêm các link khác nếu muốn #}
        {# <p class="mb-0 small"><a href="#" class="text-light">Liên hệ</a> | <a href="#" class="text-light">Giới thiệu</a></p> #}
    </div>
</footer>
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">

</div>
</body>

</html>